# DXFファイルの単位系混在問題の詳細分析

作成日: 2025-06-28
分析者: Claude

## 概要

両DXFファイルとも、**INSERT座標（ブロック参照位置）とブロック内部の座標が異なる単位系**で記録されている特殊な構造になっています。

## 1. 単位系の混在状況

### 1.1 敷地図（01_敷地図.dxf）

| 要素 | 座標値の例 | 実際の単位 | 期待される解釈 |
|------|-----------|------------|----------------|
| **ヘッダー** | INSUNITS=4 | - | ミリメートル指定 |
| **INSERT座標** | (233.88, 167.00) | メートル | 建物配置位置（約234m, 167m） |
| **ブロック内座標** | (-200.00, 138.50) | メートル | 建物の輪郭（400m × 277m） |

### 1.2 完成形（02_完成形.dxf）

| 要素 | 座標値の例 | 実際の単位 | 期待される解釈 |
|------|-----------|------------|----------------|
| **ヘッダー** | INSUNITS=4 | - | ミリメートル指定 |
| **INSERT座標** | (259.88, 192.08) | メートル | 建物配置位置（約260m, 192m） |
| **ブロック内座標** | (-200.00, 138.50) | ミリメートル | 部屋や設備の詳細 |

## 2. 問題の発生メカニズム

### 2.1 現在の処理フロー

1. **DXFファイル読み込み**
   - INSUNITS=4（ミリメートル）を検出
   - 全ての座標をミリメートルとして扱う

2. **ブロック展開**
   - INSERT座標: 259.88 → 259.88mm（誤り：実際は259.88m）
   - ブロック内: 400.00 → 400.00mm（正しい）

3. **単位補正**
   - 全体サイズが小さすぎる（260mm × 192mm）と判定
   - 1000倍変換を適用
   - 結果: 260,000mm × 192,000mm（260m × 192m）← INSERT座標は正しい
   - しかし: ブロック内も1000倍 → 400,000mm（400m）← 過大

### 2.2 結果として生じる問題

- **敷地図**: INSERT座標もブロック内もメートル単位なので、1000倍変換で正しく処理される
- **完成形**: INSERT座標（メートル）とブロック内（ミリメートル）が混在し、全体が過大になる

## 3. なぜこのような構造になっているか

### 推測される理由

1. **CADソフトの仕様**
   - 建築CADでは、全体配置図（メートル単位）と詳細図（ミリメートル単位）を混在させることがある
   - ブロック定義は詳細図として作成され、配置時にメートル座標で指定

2. **作図の経緯**
   - 敷地図: 全体図なので全てメートル単位で統一
   - 完成形: 詳細な間取りを含むため、ブロック内はミリメートル単位で作図

## 4. 具体的な数値例

### 完成形の実際のサイズ

```
INSERT座標範囲: 213.5 × 166.8
→ 建物全体: 213.5m × 166.8m（正しいサイズ）

ブロック内座標の例:
- FcPack%d0: 118.8 × 145.9（mm単位の部屋サイズ）
- FcPack%d1: 122.1 × 245.1（mm単位の部屋サイズ）
- FcPack%d2: 400.0 × 277.0（mm単位の大きな区画）
```

現在の処理では、これらが全て1000倍されて：
- 全体: 1,098,644mm × 972,724mm（約1.1km × 1km）← 誤り

## 5. 解決の方向性

### 5.1 短期的解決策
- INSERT座標の範囲（213.5m × 166.8m）を信頼し、これを最終サイズとする
- ブロック内座標は相対的な配置情報として扱う

### 5.2 長期的解決策
1. **二段階処理**
   - INSERT座標から全体サイズを決定
   - ブロック内座標を適切にスケーリング

2. **ヒューリスティックな判定**
   - INSERT座標とブロック内座標の比率から単位系を推定
   - 建築図面として妥当なサイズに調整

## 6. まとめ

この問題は、CADファイルで異なるスケールの情報を混在させる一般的な手法に起因しています。完全な解決には、INSERT座標とブロック内座標を別々に処理し、建築図面として妥当なサイズに調整する高度なロジックが必要です。