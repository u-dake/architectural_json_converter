# スケール問題の詳細分析

作成日: 2025-06-28
問題: DXF→PDF変換時に図面が小さく表示される

## 1. 現在の状況

### 変換結果
- 敷地図: 実世界4000×2770mm → 用紙上40×28mm（A3使用率9.5%）
- 完成形: 実世界10986×9727mm → 用紙上110×97mm（A3使用率26.2%）

### 問題点
- 図面がA3用紙の中央に非常に小さく表示される
- 期待される結果はA3用紙の80-90%程度を使用すること

## 2. 技術的分析

### DXFファイルの単位問題
1. **INSUNITS = 4（ミリメートル）**
2. **実際の座標値**: 400 × 277（単位不明）
3. **SafeDXFConverterの処理**:
   - 座標を400mm × 277mmとして読み込む
   - cm単位と判断して10倍 → 4000mm × 2770mm
   - しかし、これでも建築図面として小さすぎる

### 単位変換の問題
建築図面の典型的なサイズ：
- 小規模住宅: 10m × 10m = 10000mm × 10000mm
- 中規模建築: 40m × 30m = 40000mm × 30000mm
- 大規模建築: 100m × 100m = 100000mm × 100000mm

現在の変換結果（4000mm × 2770mm）は4m × 2.77mで、建築図面として小さすぎます。

## 3. 可能な原因

### 原因1: DXFファイルの座標がメートル単位
- 座標値400 = 400メートル
- INSUNITSは4（mm）だが、実際はメートル単位で記録されている
- 必要な変換: 1000倍（m→mm）

### 原因2: 二段階の単位誤差
- DXFファイルの座標: デシメートル単位（400 = 40m）
- 必要な変換: 100倍

### 原因3: CADスケールの追加適用が必要
- 現在は単純に1:100を適用
- 追加のスケール補正が必要かもしれない

## 4. 解決案

### 案1: 単位検出ロジックの改善
```python
if 10 < width < 100:  # メートル単位
    factor = 1000.0
elif 100 < width < 1000:  # デシメートル or センチメートル単位
    factor = 100.0 or 10.0
elif 1000 < width < 10000:  # ミリメートル単位（正しい）
    factor = 1.0
```

### 案2: 参照PDFとのサイズ比較
- ルートディレクトリの01_敷地図.pdfのサイズを測定
- 生成PDFとの比率を計算
- その比率を適用

### 案3: ユーザー指定の単位係数
- コマンドラインオプションで単位係数を指定可能にする
- 例: `--unit-factor 100` で100倍の補正

## 5. 次のステップ

1. **参照PDFの確認**
   - ルートの01_敷地図.pdfを開いて実際のサイズを確認
   - 正しいサイズの図面がどの程度の大きさか測定

2. **単位検出の改善**
   - より広い範囲での単位判定
   - 建築図面の典型的なサイズに基づく判定

3. **デバッグ情報の追加**
   - 元の座標値（変換前）のログ出力
   - 各段階での変換状況の詳細ログ