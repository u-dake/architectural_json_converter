# DXF → PDF スケール問題・リファクタリング方針（2025-06-28）

## 1. 現状の課題

| No | 内容                                         | 影響                          |
|----|--------------------------------------------|-----------------------------|
| 1  | **モデル空間全体の外接矩形をそのまま 1:100 で配置**    | 建物が A3 上で豆粒サイズになる        |
| 2  | 寸法線・注釈テキストも矩形計算に含まれる               | 建物本体より注釈が広いため拡大しきれない |
| 3  | 固定余白 20 mm・タイトルブロック 5 mm を想定           | 実際には下端 35 mm 必要など可変   |
| 4  | スケール計算ロジックが `CADStandardVisualizer` に直書き | テスト困難・再利用性低い           |

## 2. 追加で判明した知見

* 多くの設計 DXF は **モデル空間 = 原寸 (mm)**。ペーパー空間でビューポートを 1:100 に設定し、さらにビューポート枠を A3 にレイアウトする。
* 寸法値・指示線はモデル空間 1:1 で描いてあるため、矩形算出に入れると実体より遥かに大きくなる。

## 3. 改善アーキテクチャ

```
+---------------------------+          +---------------------------+
| SafeDXFConverter          |          | CADStandardVisualizer    |
|  └─ GeometryCollection    |          |  ├─ LayoutUtil.fit_scale |<── 新設
+---------------------------+          |  └─ DrawEngine           |
                                        +---------------------------+
```

1. **LayoutUtil** に用紙フィッティング関数 `compute_fit_scale()` を分離（今回実装）。
2. `CADStandardVisualizer` は
   * (a) 建物本体境界を取得（寸法・テキスト除外）
   * (b) 1:100 基準 → `compute_fit_scale()` で横幅 90 % 優先で拡大
   * (c) 実効縮尺をタイトルブロックに反映
3. 余白は `margin_mm` を変数化（初期 12 mm）。

## 4. 残タスク

| 優先度 | タスク                                    |
|--------|----------------------------------------|
| ★      | ペーパー空間 VIEWPORT の自動検出と実スケール逆算 |
| ★      | タイトルブロック領域 (下 35 mm) を動的確保      |
| ☆      | ページオプション: A3 縦/横, A2, A4 対応        |
| ☆      | カラーマップ・線幅自動調整（モノクロ/カラー）          |

## 5. テスト指標

1. サンプル `02_完成形.dxf` → A3 PDF で建物幅が 350 mm ±20 mm になること
2. `sample_data/site_plan/01_敷地図.dxf` も同様にページ幅 70 % 以上を占有
3. 実効縮尺がタイトルブロックに出力され、寸法線・注釈が切れない

---
*作成: 2025-06-28* 